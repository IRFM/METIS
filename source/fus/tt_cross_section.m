% ecm in eV , sima in m^2
function [sigma,sv] = tt_cross_section(ecm,mode)

if nargin == 1
  mode = 3; % use new fir from D. Coster
end

ecm = ecm ./ 1e3;

%REFERENCE: NRL PLASMA FORMULARY (2013) - PAGE 45 (CHAPTER: THERMONUCLEAR FUSION)
% ---------------------------------------------------------------------------------
% TT THERMONUCLEAR REACTIONS: SIGMAV_TT (CM3 / SEC), TI_TT (KEV)
sigmav_tt = [3.3e-22, 7.1e-21, 1.4e-19, 7.2e-19, 2.5e-18, 8.7e-18, 1.9e-17, 4.2e-17, 8.4e-17, 8.0e-17];
ti_tt     = [1., 2., 5., 10., 20., 50., 100., 200., 500., 1000.];
sigmav_tt = sigmav_tt * 1e-6;
sv        = 10 .^ interp1(log10(ti_tt),log10(sigmav_tt),log10(ecm),'spline');
sv        = zbornesv(min(ti_tt),max(ti_tt),ecm,sv);
%
switch mode
case 1
  % CONSTANT FOR TT REACTIONS (SECOND ALTERNATIVE METHOD - NOT USED) 
  % REFERENCE: http://www.kayelaby.npl.co.uk/atomic_and_nuclear_physics/4_7/4_7_4.html
  a_tt = 175.;
  r_tt = 38.41;
  beta_tt = 9.6e-3;
  S = a_tt .* exp(- beta_tt .* ecm);
  cross_section = S ./ ecm .* exp(-r_tt ./ sqrt(ecm));
  sigma = cross_section .* 1e-28; 
  
case 2
  % TT BEAM-THERMAL REACTIONS
  % FIT NRL P44
  sa1_tt = 38.39;
  sa2_tt = 448.;
  sa3_tt = 1.02e-3;
  sa4_tt = 2.09;
  sa5_tt = 0.;
  
  % WITH FIT NRL (P44)
  % UNITS: ECM (KEV) CROSS SECTION (BARN)
  coeff1 = (sa4_tt - sa3_tt .* ecm) .^ 2 + 1;
  coeff2 = exp(sa1_tt .* ecm  .^ (-1/2)) - 1;
  cross_section = ((sa5_tt + coeff1 .^(-1) .* sa2_tt) ./ (ecm .* coeff2));
  sigma = cross_section .* 1e-28;
  
case 3
  %disp('here');
  % fit from D. Coster
  %  Data from fitting to the integrated ENDF cross-sections.
  % Data taken from 
  % https://gforge6.eufus.eu/svn/amnsproto/curation/nuclear/work_thermonuclear_T(d,n)4He.dat
  % https://gforge6.eufus.eu/svn/amnsproto/curation/nuclear/work_thermonuclear_T(t,2n)4He.dat
  % Revision: 640 & 641
  %   Coefficient 	 T(t,2n)4He        T(d,n)4He
  %  BG (JkeV) 	 38.4224306526     34.3825626248
  %  A0		 1.83514616e+05    1.17646521e+07
  %  A1 	        -3.17779782e+02    3.76766772e+05
  %  A2		 3.76709752e+00    1.50959648e+03
  %  A3	        -2.60896847e-03    1.87005608e+00
  %  A4		 1.21563195e-06   -1.55585136e-03
  %  A5               6.78016367e-11    1.03432306e-06
  %  B1		 3.36105299e-05    1.93897390e-02
  %  B2		 1.86611385e-05   -9.01911596e-04
  %  B3		-2.88648569e-08    1.28041119e-05
  %  B4		 1.45561737e-11   -5.92696396e-09
  %  B5              -5.27692243e-16    2.33664641e-12
  %  Energy range 	 0-10000 	   0-10000
  %  Max rel err      0.036130036251    0.0480449615668
  %  Norm max err     0.0139943884821   0.00391502033512
  %  Norm L2 err	 0.00392374859823  0.00958364073524
  
  % translated from Python:
  %    C={}
  %  C['T(d,n)4He']   = [ 34.3825626248, 1124647.29896, 1.19715856e-09, 1.36011022e-02, 6.73974307e-02, 4.27207460e-03, 1.25872645e-02, -1.01059235e-04, 1.26209304e-05 ]
  %  C['T(t,2n)4He']  = [ 38.4224306526, 1404460.50227, 2.86867049e-11, -1.26581396e-02, -6.68347948e-01, 6.31775307e-03, 1.44900887e-01, -3.93623787e-03, 1.74153264e-02 ]
  %  
  %  def sigma_v(T, C):
  %      T = T/1000
  %      Bg, mrc2, C1, C2, C3, C4, C5, C6, C7 = C
  %  
  %  #    def theta(T):
  %  #        return 
  %      theta = T / (1 - T * (C2+T*(C4+T*C6))/(1+T*(C3+T*(C5+T*C7))))
  %          
  %      xi = (Bg**2/(4.0 * theta))**(1.0/3.0)
  %  
  %      return  C1 * theta * np.sqrt(xi / (mrc2 * T**3)) * np.exp(-3*xi) * 1e-6
  %
  % Coefficient      T(d,n)4He	     T(t,2n)4He
  % Ti range (keV) 	 1-100               0.1-1000
  % (A (mV)Ima(%)  	 ???
  C = [ 38.4224306526, 1404460.50227, 2.86867049e-11, -1.26581396e-02, -6.68347948e-01, 6.31775307e-03, 1.44900887e-01, -3.93623787e-03, 1.74153264e-02 ];
  Bg   = C(1);
  mrc2 = C(2);
  C = C(3:end);
  theta = ecm ./ (1 - ecm .* (C(2) + ecm .* (C(4) + ecm .* C(6))) ./ (1 + ecm .* (C(3) + ecm .* (C(5) + ecm .* C(7)))));
  xi = (Bg ^ 2 ./ (4.0 .* theta)) .^ (1.0/3.0);
  sv = C(1) .* theta .* sqrt(xi ./ (mrc2 .* ecm .^ 3)) .* exp(-3 .* xi) .* 1e-6;
  
  % translated from Python:
  %    S={}
  %    S['T(t,2n)4He']   = [ 38.4224306526, 1.83514616e+05, -3.17779782e+02, 3.76709752e+00, -2.60896847e-03, 1.21563195e-06, 6.78016367e-11, 3.36105299e-05, 1.86611385e-05, -2.88648569e-08, 1.45561737e-11, -5.27692243e-16 ]
  %    S['T(d,n)4He']    = [ 34.3825626248, 1.17646521e+07, 3.76766772e+05, 1.50959648e+03, 1.87005608e+00, -1.55585136e-03, 1.03432306e-06, 1.93897390e-02, -9.01911596e-04, 1.28041119e-05, -5.92696396e-09, 2.33664641e-12 ]
  %  
  %    def sigma (E, C):
  %        E = E / 1000.0
  %        BG, A0, A1, A2, A3, A4, A5, B1, B2, B3, B4, B5 = C
  %        S = (A0 + E*(A1 + E*(A2 + E*(A3 + E*(A4 + A5*E))))) / (1 + E*(B1 + E*(B2 + E*(B3 + E*(B4 + B5*E)))))
  %        return S / (E * np.exp(BG / np.sqrt(E))) * 1e-31
  C  = [ 38.4224306526, 1.83514616e+05, -3.17779782e+02, 3.76709752e+00, -2.60896847e-03, 1.21563195e-06, 6.78016367e-11, 3.36105299e-05, 1.86611385e-05, -2.88648569e-08, 1.45561737e-11, -5.27692243e-16 ];
  BG = C(1);
  A0 = C(2);
  A1 = C(3);
  A2 = C(4);
  A3 = C(5);
  A4 = C(6);
  A5 = C(7);
  B1 = C(8);
  B2 = C(9);
  B3 = C(10);
  B4 = C(11);
  B5 = C(12);
  S = (A0 + ecm .* (A1 + ecm .* (A2 + ecm .* (A3 + ecm .* (A4 + A5 .* ecm))))) ./ (1 + ecm .* (B1 + ecm .* (B2 + ecm .* (B3 + ecm .*(B4 + B5 .* ecm)))));
  sigma =  S ./ (ecm .* exp(BG ./ sqrt(ecm))) .* 1e-31;

otherwise
  % REFERENCE: http://www.nndc.bnl.gov/exfor/endf00.jsp
  % -----------------------------------------------------
  % LIBRARY = ENDF/B-VII.1 ; REACTION = H-3(T,2N)HE-4,SIG
  % TABLE PROVIDED BY JACOB ERIKSSON, UPPSALA
  % -----------------------------------------------------
  % UNITS: ECM_TT (EV), SIG_TT (BARN) 
  ecm_tt = [ 100., 500., 1000., 2000., 2828.43, 3363.59, 3668.02, 3830.41, 3872.12, 3887.88, 3915.61, 3944.42, ...
       3964.18, 3988.02, 4012.69, 4037.99, 4063.06, 4087.88, 4112.46, 4136.81, 4160.91, 4184.78, 4208.4, 4231.79, ...
       4266.47, 4300.52, 4334.13, 4367.12, 4399.67, 4431.61, 4463.11, 4494.01, 4524.47, 4554.35, 4583.79, 4612.66, ...
       4641.1, 4678.49, 4715.01, 4750.65, 4785.44, 4819.38, 4852.5, 4884.79, 4916.28, 4946.98, 4991.7, 5034.48, ...
       5075.84, 5115.37, 5153.56, 5190.04, 5225.25, 5270.6, 5313.47, 5353.98, 5392.24, 5428.35, 5478.47, 5524.87, ...
       5566.87, 5605.69, 5653.52, 5695.71, 5750.32, 5780.95, 5834.95, 5891.17, 5929.81, 5976.51, 6027.03, 6080.6, ...
       6132.96, 6184.1, 6234.06, 6282.84, 6330.46, 6376.93, 6422.28, 6488.4, 6551.74, 6613.03, 6671.7, 6728.42, ...
       6782.66, 6835.07, 6902.63, 6966.58, 7027.06, 7084.24, 7138.28, 7214.13, 7282.93, 7346.63, 7425.29, 7494.81, ...
       7556.17, 7634.07, 7699.88, 7773.84, 7853.87, 7926.6, 8000., 8083.24, 8163.84, 8241.03, 8315.7, 8412.11, 8503.52, ...
       8590.11, 8672.09, 8749.66, 8857.6, 8957.81, 9048.77, 9133.05, 9237.17, 9329.24, 9448.75, 9515.96, 9634.73, ... 
       9758.76, 9844.24, 9947.81, 10057.1, 10168.8, 10274.6, 10374.7, 10515.7, 10643.9, 10763., 10910.3, 11040.9, ...
       11156.5, 11303.6, 11428.2, 11568.5, 11720.8, 11859.6, 12000., 12171., 12330.1, 12428.3, 12614.7, 12780.1, ...
       12926.6, 13113.2, 13271.5, 13450., 13643.9, 13820.8, 14000., 14228.2, 14438.5, 14625., 14867.9, 15125.9, ...
       15339.8, 15572.4, 15784.8, 16000., 16237.3, 16540.8, 16799.2, 17091.7, 17398.6, 17739.8, 18000., 18344., ...
       18637., 18968.8, 19330.8, 19662.6, 20000., 20434.5, 20867.9, 21296.6, 21720.2, 22138.7, 22551.8, 22959.3, ...
       23361., 23954.3, 24530.8, 25096.5, 25645.1, 26182.2, 26884.9, 27560.9, 28210.1, 28832.5, 29712.1, 30542.8, ...
       31308.6, 32028.1, 32930.4, 33740.8, 34810., 35962.5, 36932., 37999.7, 39321.8, 40000., 41516.9, 42959.2, ...
       44297.1, 45561.4, 47156.5, 48597.9, 50512.5, 51611.1, 53591.4, 55713.2, 57207.8, 59054.5, 60000., 63183.1, ...
       65976.7, 69233.4, 71780.9, 75779.1, 80000., 86377.9, 91015.7, 96910.8, 100000., 109545., 120000., 134707., ...
       140000., 160000., 180000., 200000., 220000., 240000., 260000., 280000., 300000., 350000., 400000., 450000., 524404., ... 
       648074., 800000., 900000., 1.E+06, 1.14891E+06, 1.34907E+06, 1.54919E+06, 1.64924E+06, 1.7E+06, 1.8E+06, ...
       1.9E+06, 2E+06, 2.1E+06, 2.2E+06, 2.3E+06, 2.4E+06, 2.5E+06, 2.60914E+06, 2.7018E+06, 2.80474E+06, ...
       2.93345E+06, 3E+06, 3.08426E+06, 3.1566E+06, 3.23915E+06, 3.33E+06, 3.41394E+06, 3.5E+06, 3.61881E+06, ...
       3.74556E+06, 3.8889E+06, 4E+06, 4.16364E+06, 4.30574E+06, 4.4697E+06, 4.65231E+06, 4.82302E+06, 5E+06, ...
       5.31162E+06, 5.58732E+06, 5.91122E+06, 6.26492E+06, 6.51814E+06, 6.83555E+06, 7E+06, 7.46332E+06, ...
       7.87459E+06, 8.35932E+06, 8.91183E+06, 9.44025E+06, 1E+07, 1.1941E+07, 1.39019E+07, 1.5E+07, ...
       1.86121E+07, 2.E+07  1e8];

  sig_tt = [ 0., 3.0969E-31, 9.2179E-22, 3.7603E-15, 1.2005E-12, 1.4742E-11, 4.7469E-11, 8.3483E-11, ...
       9.5941E-11, 1.0106E-10, 1.1065E-10, 1.2144E-10, 1.2938E-10, 1.3955E-10, 1.5081E-10, 1.6317E-10, ...
       1.7629E-10, 1.9019E-10, 2.0488E-10, 2.2041E-10, 2.3678E-10, 2.5403E-10, 2.7219E-10, 2.9126E-10, ...
       3.217E-10, 3.5425E-10, 3.8915E-10, 4.263E-10, 4.6594E-10, 5.0792E-10, 5.5251E-10, 5.9951E-10, ...
       6.4923E-10, 7.0142E-10, 7.5638E-10, 8.1386E-10, 8.7416E-10, 9.5931E-10, 1.0493E-09, 1.14412E-09, ...
       1.24371E-09, 1.34802E-09, 1.45698E-09, 1.5705E-09, 1.68845E-09, 1.81073E-09, 2.00246E-09, 2.20202E-09, ...
       2.41097E-09, 2.62645E-09, 2.85009E-09, 3.07884E-09, 3.31439E-09, 3.64039E-09, 3.97348E-09, ...
       4.31186E-09, 4.65379E-09, 4.99759E-09, 5.5106E-09, 6.0249E-09, 6.52525E-09, 7.01878E-09, 7.67041E-09, ...
       8.28721E-09, 9.14778E-09, 9.66296E-09, 1.06312E-08, 1.17255E-08, 1.25318E-08, 1.35687E-08, 1.4771E-08, ...
       1.61432E-08, 1.75867E-08, 1.91008E-08, 2.06843E-08, 2.23358E-08, 2.40539E-08, 2.58366E-08, 2.7682E-08, ...
       3.05701E-08, 3.357E-08, 3.67043E-08, 3.99301E-08, 4.32713E-08, 4.66821E-08, 5.01879E-08, 5.50291E-08,  ...
       5.99638E-08, 6.49654E-08, 7.00084E-08, 7.50682E-08, 8.26807E-08, 9.01291E-08, 9.75133E-08, 1.07315E-07, ...
       1.16642E-07, 1.25421E-07, 1.37344E-07, 1.48131E-07, 1.61076E-07, 1.76116E-07, 1.90766E-07, 2.0655E-07, ...
       2.25722E-07, 2.4565E-07, 2.66059E-07, 2.87099E-07, 3.16249E-07, 3.46064E-07, 3.76378E-07, 4.07029E-07, ...
       4.37862E-07, 4.83888E-07, 5.30043E-07, 5.7495E-07, 6.19242E-07, 6.77712E-07, 7.33039E-07, 8.10191E-07, ...
       8.56352E-07, 9.4305E-07, 1.04093E-06, 1.11297E-06, 1.20551E-06, 1.3097E-06, 1.42333E-06, 1.53806E-06, ...
       1.65333E-06, 1.82698E-06, 1.99711E-06, 2.16595E-06, 2.39028E-06, 2.60392E-06, 2.80513E-06, 3.0785E-06, ...
       3.32591E-06, 3.62285E-06, 3.96786E-06, 4.30388E-06, 4.6658E-06, 5.13757E-06, 5.60844E-06, 5.91546E-06, ...
       6.53287E-06, 7.12079E-06, 7.6744E-06, 8.42641E-06, 9.10676E-06, 9.92301E-06, 1.0871E-05, 1.17937E-05, ...
       1.2787E-05, 1.41405E-05, 1.54794E-05, 1.6744E-05, 1.85036E-05, 2.05173E-05, 2.23063E-05, 2.4378E-05, ...
       2.6389E-05, 2.8548E-05, 3.10727E-05, 3.4532E-05, 3.76884E-05, 4.15054E-05, 4.58E-05, 5.09336E-05, ...
       5.5114E-05, 6.10011E-05, 6.63511E-05, 7.27954E-05, 8.03099E-05, 8.76512E-05, 9.5579E-05, 0.000106461, ...
       0.000118125, 0.00013048, 0.000143514, 0.000157212, 0.000171556, 0.000186526, 0.000202097, 0.000226594, ...
       0.00025216, 0.000278966, 0.00030662, 0.000335305, 0.000375281, 0.000416383, 0.000458334, 0.000500865, ...
       0.000564853, 0.000629489, 0.000692713, 0.00075531, 0.000838187, 0.000916761, 0.00102641, 0.00115217, ...
       0.00126397, 0.00139338, 0.0015626, 0.0016532, 0.00183791, 0.00202548, 0.00221019, 0.00239445, 0.00264077, ...
       0.002877, 0.00321138, 0.00341414, 0.00380025, 0.00424422, 0.0045763, 0.00500928, 0.0052409, 0.00587377, ...
       0.00646183, 0.00718626, 0.00778241, 0.00877061, 0.0098843, 0.0113474, 0.0124673, 0.0139581, 0.014769, ...
       0.0169569, 0.019469, 0.0226387, 0.023806, 0.02773, 0.031253, 0.034408, 0.037241, 0.039793, 0.042105, ...
       0.044212, 0.046145, 0.050377, 0.053985, 0.05718, 0.0614636, 0.0680301, 0.075838, 0.081176, 0.086742, ...
       0.0955366, 0.107944, 0.120348, 0.12611, 0.1289, 0.1337, 0.13752, 0.14013, 0.14135, 0.14106, 0.13928, ...
       0.13608, 0.13165, 0.123334, 0.116934, 0.110445, 0.103131, 0.099658, 0.093281, 0.0882586, 0.082983, ...
       0.07768, 0.0731977, 0.068974, 0.0645991, 0.0603779, 0.0560869, 0.05307, 0.0497395, 0.0471133, 0.0443515, ...
       0.0415718, 0.0392193, 0.037, 0.0346623, 0.0328196, 0.0308826, 0.0290048, 0.0277903, 0.0263999, 0.025731, ...
       0.024415, 0.0233655, 0.0222497, 0.0211133, 0.0201402, 0.019212, 0.0185988, 0.0180887, 0.017839, ...
       0.0173447, 0.017183  0];


     % TABLES REQUIRE ECM (EV), RETURN CROSS SECTIONS (BARN)
     % CF. ENDF DATABASE (http://www.nndc.bnl.gov/exfor/endf00.jsp)
     cross_section = interp1(ecm_tt,sig_tt,1e3 .* ecm,'pchip',0);
     sigma = cross_section .* 1e-28;
     % CROSS SECTION CONVERSION FROM BARN TO M^2
      
 end

% fonction pour les bornes  sur ti (sv=0 hors intervalle)
function sv=zbornesv(timin,timax,ti,sv)

ind = find(ti < min(timin,timax) | ti > max(timin,timax));
sv(ind)=zeros(1,length(ind));
